# A4: 調査報告書 (debug_helpPoints)

## 1. 再現手順（最短）
1. ログイン済みの状態でアプリを開く。
2. 読み込みが完了する前に「+1」ボタンを1回クリックする。
3. 数秒後（ロード完了後）、もう一度「+1」ボタンをクリックする。
4. 画面をリロードする。
5. 最初の一回目のクリックが反映されておらず、二回目からカウントされている（あるいは両方消えている）ことを確認。

## 2. 期待される挙動
- 読み込み中であっても、クリックした分が正しく保存され、ロード後の値と合算される。
- あるいは、読み込みが完了するまでボタンを押せないよう制御されている。

## 3. 実際の挙動
- `isHydrated` フラグが `false` の間は `saveData()` が保存を意図的にスキップする。
- 読み込み完了後に、メモリ上の `helpTotal` がロードされた値で無条件に上書きされる。
- ログイン成功時の `loadDataFromSupabase` 正常系で `isHydrated = true` に設定するコードが欠落している（ログイン中は永久に保存されない）。

## 4. 根因
### 根因1: hydration フラグの更新漏れ
- ファイル: `app.js`
- 関数: `loadDataFromSupabase`
- 内容: 正常終了時に `isHydrated = true` にしていない。このため、ログインユーザーは常に `saveData` がガードされ、保存が失敗し続ける。

### 根因2: 非同期ロードとユーザー操作の競合
- ファイル: `app.js`
- 関数: `setupHelpButton`
- 内容: 非同期の `loadData` を待たずにボタンを `removeAttribute('disabled')` している。

### 根因3: 破壊的な上書き
- ファイル: `app.js`
- 関数: `loadData`, `loadDataFromSupabase`
- 内容: `helpTotal = savedValue` と直接代入しているため、ロード前にクリックして増えた分が消失する。

## 5. 最小修正案
1. **hydration フラグの修正**: `loadDataFromSupabase` の `try` ブロック末尾に `isHydrated = true;` を追加する。
2. **ボタンの有効化タイミング修正**: `setupHelpButton` 内での `disabled` 解除をやめ、 `loadData` の完了時（`updateHelpUI` を呼ぶ直前など）にボタンを有効化する。
3. **安全な代入**: `helpTotal` を代入する際、もし既に 0 以上（クリック済み）であれば加算する等のマージロジックを検討するか、2の「押させない」対策で封じ込める。

## 6. 手動テスト案
1. **ログイン状態での保存テスト**: ログインし、+1ボタンを押し、リロードして値が保持されるか確認。
2. **高速クリックテスト**: ページを開いた瞬間に連打し、ボタンが最初は無効であることを確認。
3. **データ競合テスト**: ロード中にクリックができない、あるいはクリックした分がロード値に正しく上書きされずに残ることを確認。
